DEFINT A-Z
DIM SHARED BITMASK(16) AS INTEGER
TYPE BlockDataT
  w AS INTEGER
  h AS INTEGER
  r AS INTEGER
  rx AS INTEGER
  ry AS INTEGER
  map AS INTEGER
  col AS INTEGER
END TYPE
COMMON STAGEW, STAGEH, BLOCKX, BLOCKY, BLOCKCUR, BLOCKNEXT, STATUS, LEVEL, SCORE&
DIM SHARED BLOCK(19) AS BlockDataT
DIM SHARED STAGE(20, 10) AS INTEGER
DECLARE FUNCTION HITTEST(B AS BlockDataT, X0 AS INTEGER, Y0 AS INTEGER)
DECLARE SUB NEWBLOCK()
DECLARE SUB MOVE(DIR AS INTEGER)
DECLARE SUB ROTATE()
DECLARE SUB DROP()
DECLARE SUB FREEZE()
DECLARE SUB REDUCE()
DECLARE SUB DRAWBLOCK(CL AS INTEGER)
DECLARE SUB DRAWBLOCKNEXT()
DECLARE SUB DRAWSTAGE()
DECLARE SUB DRAWFRAME()
DIM SHARED DELAY(6) AS SINGLE

DELAY(0)=1
DELAY(1)=0.8
DELAY(2)=0.6
DELAY(3)=0.4
DELAY(4)=0.2
DELAY(5)=0.1
FOR I = 0 TO 14
  BITMASK[I] = 2^I
NEXT I
DATA 2,2,0,0,0,&H0F,1
DATA 4,1,2,0,2,&H0F,2
DATA 1,4,0,2,1,&H0F,2
DATA 2,3,0,1,4,&H2D,3
DATA 3,2,1,1,3,&H1E,3
DATA 2,3,0,1,6,&H1E,4
DATA 3,2,1,1,5,&H33,4
DATA 2,3,0,1,8,&H2E,5
DATA 3,2,1,1,9,&H17,5
DATA 2,3,1,1,10,&H1D,5
DATA 3,2,1,0,7,&H3A,5
DATA 2,3,1,1,12,&H2B,6
DATA 3,2,1,0,13,&H0F,6
DATA 2,3,0,1,14,&H35,6
DATA 3,2,1,1,11,&H3C,6
DATA 2,3,0,1,16,&H17,7
DATA 3,2,1,1,17,&H39,7
DATA 2,3,1,1,18,&H3A,7
DATA 3,2,1,0,15,&H27,7
FOR I = 0 TO 18
  READ BLOCK(I).w, BLOCK(I).h, BLOCK(I).rx, BLOCK(I).ry, BLOCK(I).r, BLOCK(I).map, BLOCK(I).col
NEXT I
STAGEW = 10 : STAGEH = 20 : SCORE& = 0 : STATUS = 0
FOR Y=0 TO STAGEH-1: FOR X=0 TO STAGEW-1
  STAGE(Y,X)=0
NEXT X: NEXT Y
RANDOMIZE TIMER
CALL DRAWFRAME : CALL DRAWSTAGE
BLOCKNEXT = (RND * 100) MOD 19 : CALL NEWBLOCK

DO
  TS# = TIMER
  DO
    WAIT &H3DA, 8
    WAIT &H3DA, 8, 8

    K$=INKEY$
    SELECT CASE K$
      CASE CHR$(27) 
        STATUS = -2
        EXIT DO
      CASE CHR$(0)+CHR$(72)
        CALL ROTATE
      CASE CHR$(0)+CHR$(75)
        CALL MOVE(-1)
      CASE CHR$(0)+CHR$(77)
        CALL MOVE(1)
      CASE CHR$(0)+CHR$(80)
        CALL DROP
    END SELECT

    TS2# = TIMER
  LOOP UNTIL STATUS<0 OR TS2#-TS# > 0.5

  IF STATUS >= 0 THEN
    IF HITTEST(BLOCK(BLOCKCUR), BLOCKX, BLOCKY + 1) <> 0 THEN
      CALL FREEZE: CALL NEWBLOCK
    ELSE
      CALL DRAWBLOCK(1)
      BLOCKY = BLOCKY + 1
      CALL DRAWBLOCK(0)
    END IF
  END IF
LOOP WHILE STATUS >= 0

IF STATUS = -1 THEN
  COLOR 0: LINE (118,86)-(202,97),,BF
  LOCATE 12,16: COLOR 12: PRINT "GAME  OVER";
  SOUND 100,2
  WHILE INPUT$(1)="":WEND
END IF
SCREEN 0: WIDTH 80: CLS: END

FUNCTION HITTEST(B AS BlockDataT, X0 AS INTEGER, Y0 AS INTEGER)
  SHARED STAGEW, STAGEH
  RES = 0 : W = B.w : H = B.h
  FOR Y = 0 TO H-1: FOR X = 0 TO W-1
    IF (B.map AND BITMASK(X+Y*W)) <> 0 THEN
      SX = X0 + X : SY = Y0 + Y
      IF SX < 0 OR SX >= STAGEW OR SY >= STAGEH THEN
        RES = 1 : GOTO ENDFUNC
      ELSEIF SY >= 0 THEN
        IF STAGE(SY,SX) <> 0 THEN
          RES = 1 : GOTO ENDFUNC
	    END IF
      END IF
    END IF
  NEXT X: NEXT Y
ENDFUNC:
  HITTEST = RES
END FUNCTION

SUB MOVE(DIR AS INTEGER)
  SHARED BLOCKX, BLOCKY, BLOCKCUR
  IF HITTEST(BLOCK(BLOCKCUR), BLOCKX + DIR, BLOCKY) <> 0 THEN
    EXIT SUB
  END IF
  CALL DRAWBLOCK(1)
  BLOCKX = BLOCKX + DIR
  CALL DRAWBLOCK(0)
END SUB

SUB ROTATE
  SHARED BLOCKX, BLOCKY, BLOCKCUR
  DIM B0 AS BlockDataT, B AS BlockDataT
  B0 = BLOCK(BLOCKCUR) : B = BLOCK(B0.r)
  X = BLOCKX + B0.rx - B.rx : Y = BLOCKY + B0.ry - B.ry
  IF HITTEST(B, X, Y) <> 0 THEN
    IF HITTEST(B, X - 1, Y) = 0 THEN
      X = X - 1
    ELSEIF HITTEST(B, X + 1, Y) = 0 THEN
      X = X + 1
    ELSE
      EXIT SUB
    END IF
  END IF
  CALL DRAWBLOCK(1)
  BLOCKX = X : BLOCKY = Y : BLOCKCUR = B0.r
  CALL DRAWBLOCK(0)
END SUB

SUB DROP
  SHARED BLOCKX, BLOCKY, BLOCKCUR
  CALL DRAWBLOCK(1)
  WHILE HITTEST(BLOCK(BLOCKCUR), BLOCKX, BLOCKY + 1) = 0
    BLOCKY = BLOCKY + 1
  WEND
  CALL DRAWBLOCK(0)
END SUB

SUB FREEZE
  SHARED BLOCKX, BLOCKY, BLOCKCUR, STAGEW, STAGEH, SCORE&
  W = BLOCK(BLOCKCUR).w : H = BLOCK(BLOCKCUR).h
  FOR Y = 0 TO H-1 : FOR X = 0 TO W-1
    IF (BLOCK(BLOCKCUR).map AND BITMASK(X+Y*W)) <> 0 THEN
      STAGE(Y+BLOCKY, X+BLOCKX) = BLOCK(BLOCKCUR).col
    END IF
  NEXT X : NEXT Y

  Y = STAGEH - 1: REDUCED = 0
  WHILE Y >= 0
    FULL = 1
    FOR X = 0 TO STAGEW-1
      IF STAGE(Y, X)=0 THEN
        FULL = 0 : EXIT FOR
      END IF
    NEXT X
    IF FULL = 0 THEN
      Y = Y-1
    ELSE
      FOR X = 0 TO STAGEW-1
        FOR Y1 = Y TO 1 STEP -1
          STAGE(Y1, X)=STAGE(Y1-1, X)
        NEXT Y1
        STAGE(0, X)=0
      NEXT X
      REDUCED = REDUCED + 1
    END IF
  WEND
  IF REDUCED > 0 THEN
    SCORE& = SCORE& + (REDUCED ^ 2) * 10
    SOUND 500,1: SOUND 1000,1
  ELSE
    SCORE& = SCORE& + 1
  END IF
  
  CALL DRAWSTAGE
END SUB

SUB NEWBLOCK
  SHARED BLOCKX, BLOCKY, BLOCKCUR, BLOCKNEXT, STAGEW, STATUS
  BLOCKCUR = BLOCKNEXT: BLOCKNEXT = (RND * 100) MOD 19
  BLOCKX = INT((STAGEW - BLOCK(BLOCKCUR).w) / 2): BLOCKY = 0
  IF HITTEST(BLOCK(BLOCKCUR), BLOCKX, BLOCKY) <> 0 THEN
    STATUS = -1
  ELSE
    CALL DRAWBLOCK(0) : CALL DRAWBLOCKNEXT
  END IF
END SUB

SUB DRAWBLOCK(CL AS INTEGER)
  SHARED BLOCKX, BLOCKY, BLOCKCUR, STAGEW, STAGEH
  W = BLOCK(BLOCKCUR).w : H = BLOCK(BLOCKCUR).h
  FOR Y = 0 TO H-1 : FOR X = 0 TO W-1
    IF (BLOCK(BLOCKCUR).map AND BITMASK(X+Y*W)) <> 0 THEN
      X1 = BLOCKX + X: Y1 = BLOCKY + Y
      IF X1 >= 0 AND X1 < STAGEW AND Y1 >= 0 AND Y1 < STAGEH THEN
        SX = (320-STAGEW*9)/2+X1*9: SY = (200-STAGEH*9)/2+Y1*9
        IF CL > 0 THEN
          COLOR 0
          LINE (SX,SY)-(SX+8,SY+8),,BF
        ELSE
          COLOR BLOCK(BLOCKCUR).col
          LINE (SX,SY)-(SX+8,SY+8),,B
          COLOR BLOCK(BLOCKCUR).col+8
          LINE (SX+1,SY+1)-(SX+7,SY+7),,BF
        END IF
      END IF
    END IF
  NEXT X : NEXT Y
END SUB

SUB DRAWSTAGE
  SHARED BLOCKX, BLOCKY, BLOCKCUR, STAGEW, STAGEH, SCORE&
  FOR Y = 0 TO STAGEH-1: FOR X = 0 TO STAGEW-1
    SX = (320-STAGEW*9)/2+X*9: SY = (200-STAGEH*9)/2+Y*9
    IF STAGE(Y,X)>0 THEN
      COLOR STAGE(Y,X): LINE (SX,SY)-(SX+8,SY+8),,B
      COLOR STAGE(Y,X)+8: LINE (SX+1,SY+1)-(SX+7,SY+7),,BF
    ELSE
      COLOR 0: LINE (SX,SY)-(SX+8,SY+8),,BF
    END IF
  NEXT X: NEXT Y
  LOCATE 5,3: COLOR 7: PRINT USING "########";SCORE&;
END SUB

SUB DRAWWINDOW(X AS INTEGER, Y AS INTEGER, W AS INTEGER, H AS INTEGER)
  COLOR 0: LINE (X,Y)-(X+W,Y+H),,BF
  COLOR 15: LINE (X+W+1,Y-1)-(X+W+1,Y+H+1): LINE (X-1,Y+H+1)-(X+W+1,Y+H+1)
  COLOR 8: LINE (X-1,Y-1)-(X+W,Y-1): LINE (X-1,Y-1)-(X-1,Y+H)
END SUB

SUB DRAWFRAME
  SHARED STAGEW, STAGEH
  CLS: SCREEN 13
  COLOR 7: LINE (0,0)-(319,199),,BF
  W = STAGEW * 9: H = STAGEH * 9
  X = (320-W)/2: Y = (200-H)/2
  CALL DRAWWINDOW(X,Y,W-1,H-1)
  
  CALL DRAWWINDOW(14,Y,22+6*8+2,32)
  CALL DRAWWINDOW(229,Y,42,20+4*9+3)
  COLOR 7
  LOCATE 3,3: PRINT "SCORE"
  LOCATE 3,30: PRINT "NEXT"
END SUB

SUB DRAWBLOCKNEXT
  SHARED BLOCKX, BLOCKY, BLOCKCUR, BLOCKNEXT, STAGEW, STAGEH
  COLOR 0: SX0 = 232: SY0 = 30
  LINE (SX0,SY0)-(SX0+36,SY0+36),,BF
  W = BLOCK(BLOCKNEXT).w : H = BLOCK(BLOCKNEXT).h
  X1 = (4-W)*9/2: Y1 = (4-H)*9/2
  FOR Y = 0 TO H-1 : FOR X = 0 TO W-1
    IF (BLOCK(BLOCKNEXT).map AND BITMASK(X+Y*W)) <> 0 THEN
      SX = SX0 + X1 + X*9: SY = SY0 + Y1 + Y*9
      COLOR BLOCK(BLOCKNEXT).col
      LINE (SX,SY)-(SX+8,SY+8),,B
      COLOR BLOCK(BLOCKNEXT).col+8
      LINE (SX+1,SY+1)-(SX+7,SY+7),,BF
    END IF
  NEXT X : NEXT Y
END SUB
