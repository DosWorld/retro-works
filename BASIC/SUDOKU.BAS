10 DEFINT A-Z:DIM B(9,9),BIT(15),BITN(15),MAPX(9),MAPY(9),MAPG(9)
20 FOR I=0 TO 14:BIT(I)=2^I:BITN(I)=NOT(BIT(I)):NEXT I
30 PRINT "Input sudoku":DIM BI(9):FOR Y=0 TO 8
40 PRINT Y+1;:INPUT ": ",BI(0),BI(1),BI(2),BI(3),BI(4),BI(5),BI(6),BI(7),BI(8)
50 FOR X=0 TO 8:IF BI(X)>9 OR BI(X)<0 THEN PRINT "Invalid number at row";Y+1;", column";X+1:END
60 B(Y,X)=BI(X):NEXT X:NEXT Y
70 FOR Y=0 TO 8:FOR X=0 TO 8:N=B(Y,X)
80 MAPX(X)=MAPX(X) OR BIT(N):MAPY(Y)=MAPY(Y) OR BIT(N)
90 G=(Y\3)*3+(X\3):MAPG(G)=MAPG(G) OR BIT(N)
100 NEXT X:NEXT Y:PRINT "Calculating...";
110 RN=1:WHILE RN=1:FIN=1:RN=0:FOR Y=0 TO 8
120 FOR X=0 TO 8:N=B(Y,X):IF N<>0 THEN GOTO 200
130 RN=0:G=(Y\3)*3+(X\3):M=NOT(MAPX(X) OR MAPY(Y) OR MAPG(G)) AND &H3FE
140 IF M=0 THEN PRINT "No answer at row";Y+1;", column";X+1:END
150 IF (M AND (M-1))<>0 THEN FIN=0:GOTO 200
160 RN=1:N=M:GOSUB 600:B(Y,X)=N
170 MAPX(X)=MAPX(X) OR M:MAPY(Y)=MAPY(Y) OR M:MAPG(G)=MAPG(G) OR M
200 NEXT X:NEXT Y:WEND:IF FIN=1 THEN GOSUB 500:END
210 DIM MX(9),MY(9),MG(9),ST(81,3):SP=0:SL=0
220 FOR Y=0 TO 8:FOR X=0 TO 8:N=B(Y,X):IF N<>0 THEN GOTO 250
230 G=(Y\3)*3+(X\3):ST(SL,0)=(G*256) OR (Y*16) OR X
240 ST(SL,1)=NOT(MAPX(X) OR MAPY(Y) OR MAPG(G)) AND &H3FE:SL=SL+1
250 NEXT X:NEXT Y
260 WHILE SP<SL:N=ST(SP,2):DT=ST(SP,0):G=DT\256 AND 15:Y=(DT\16) AND 15:X=DT AND 15
270 IF N<>0 THEN MG(G)=MG(G) AND BITN(N):MX(X)=MX(X) AND BITN(N):MY(Y)=MY(Y) AND BITN(N)
280 BM=ST(SP,1) AND (NOT(MG(G) OR MX(X) OR MY(Y))) AND &H3FE:GOSUB 700
290 B(Y,X)=N:ST(SP,2)=N:IF N=0 THEN IF SP>0 THEN SP=SP-1:GOTO 400 ELSE PRINT "No answer.":END
300 MG(G)=MG(G) OR BIT(N):MX(X)=MX(X) OR BIT(N):MY(Y)=MY(Y) OR BIT(N)
320 SP=SP+1:ST(SP,2)=0
400 WEND:GOSUB 500:END
500 PRINT "Complete.":FOR Y=0 TO 8:FOR X=0 TO 8:N=B(Y,X)
510 PRINT USING "# ";B(Y,X);:IF (X MOD 3)=2 THEN PRINT " ";
520 NEXT X:PRINT "":IF (Y MOD 3)=2 THEN PRINT ""
530 NEXT Y:RETURN
600 FOR NB0=1 TO 9:IF (BIT(NB0) AND N)<>0 THEN N=NB0:RETURN
610 NEXT NB0:N=0:RETURN
700 IF BM=0 THEN N=0:RETURN
710 WHILE N<9:N=N+1:IF (BIT(N) AND BM)<>0 THEN RETURN
720 WEND:N=0:RETURN
