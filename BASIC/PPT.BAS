DEFINT A-Z
TYPE ActionT
  SLIDE AS INTEGER
  EXTERNAL AS INTEGER
  TARGET AS STRING*20
  TRIGGER AS STRING*20
END TYPE
COMMON SHARED SLIDECOUNT,ACTIONCOUNT,CURRENTSLIDE
DECLARE SUB TestTX ()
DECLARE FUNCTION n$ (n%)
DECLARE SUB TX (s AS STRING)
DECLARE SUB DrawText(x as integer,y as integer,text as string)
DATA &H50,&H53,&H56,&HBE,&H00,&H00,&H2E,&HC7,&H04,&H00,&H00,&HB8,&H00,&HDB,&HCD,&H2F
DATA &H3C,&HFF,&H75,&H12,&H81,&HFB,&H50,&H54,&H75,&H0C,&HB8,&H11,&H00,&HCD,&H79,&H75
DATA &H05,&h2E,&HC7,&H04,&H01,&H00,&H5E,&H5B,&H58,&HCB

SLIDECOUNT=0
ACTIONCOUNT=0
DIM SHARED NAMELIST(64) AS STRING
DIM SHARED CONTENTLIST(64) AS STRING
DIM SHARED ACTIONLIST(256) AS ActionT
CURRENTSLIDE=0

InitTX
INPUT "请输入文件名：",FILENAME$
IF FILENAME$="" THEN FILENAME$="PPT.TXT"
PRINT "加载中……"
CALL LoadData(FILENAME$)
CALL MainLoop
TX ("KB1,1M3CU1,1")
CLOSE
END

FUNCTION n$ (A AS INTEGER)
n$ = LTRIM$(RTRIM$(STR$(A)))
END FUNCTION

SUB InitTX
    DIM A%(50)
    DEF SEG = VARSEG(A%(0))
    RESTORE
    FOR I% = 0 TO 41
        READ D%
        IF I% = 4 THEN
        D% = VARPTR(A%(49)) MOD 256
        ELSEIF I% = 5 THEN
        D% = VARPTR(A%(49)) / 256
        END IF
        POKE VARPTR(A%(0)) + I%, D%
    NEXT I%
    CALL ABSOLUTE(VARPTR(A%(0)))
    DEF SEG
    IF A%(49) = 0 THEN
        PRINT "Please run TX.COM first"
    END
    END IF
    OPEN "LPT3" FOR OUTPUT AS #1
END SUB

SUB TX (s AS STRING)
    PRINT #1, CHR$(14); "["; s; "]";
END SUB

SUB ProcessLine(MODE AS STRING, DATATEXT AS STRING)
    SELECT CASE MODE
        CASE ".CONTENT"
            CONTENTLIST(SLIDECOUNT-1)=CONTENTLIST(SLIDECOUNT-1)+DATATEXT
        CASE ".ACTION"
            ACTIONCOUNT=ACTIONCOUNT+1: I=ACTIONCOUNT-1
            ACTIONLIST(I).SLIDE=SLIDECOUNT-1
            ACTIONLIST(I).TRIGGER=UCASE$(LEFT$(DATATEXT,INSTR(DATATEXT,":")-1))
            ACTIONLIST(I).EXTERNAL=SLIDECOUNT-1
            TARGET$=RIGHT$(DATATEXT,LEN(DATATEXT)-INSTR(DATATEXT,":"))
            IF INSTR(TARGET$,"EXT$")>0 THEN
                ACTIONLIST(I).TARGET=RIGHT$(TARGET$,LEN("EXT$"))
            ELSE
                ACTIONLIST(I).TARGET=TARGET$
            END IF
    END SELECT
END SUB

SUB LoadData(FILENAME AS STRING)
    OPEN FILENAME FOR INPUT AS #2
    MODE$=""
    DO
        LINE INPUT #2,DATATEXT$
        SELECT CASE DATATEXT$
            CASE ""
            CASE ".SLIDE"
                SLIDECOUNT=SLIDECOUNT+1
                LINE INPUT #2,DATATEXT$
                NAMELIST(SLIDECOUNT-1)=DATATEXT$
            CASE ".CONTENT"
                MODE$=DATATEXT$
            CASE ".ACTION"
                MODE$=DATATEXT$
            CASE ELSE
                CALL ProcessLine(MODE$,DATATEXT$)
        END SELECT
    LOOP UNTIL (EOF(2))
    CLOSE #2
END SUB

SUB DisplaySlide(ID as INTEGER)
    CALL TX(CONTENTLIST(ID))
END SUB

SUB MainLoop
    DO
        CALL DisplaySlide(CURRENTSLIDE)
        'Handle keyboard action
        K$ = ""
        DO
            K$=INKEY$
        LOOP WHILE K$=""
        SELECT CASE K$
            CASE ""
            CASE CHR$(27)
                EXIT SUB
            CASE CHR$(0) + "G"
                CURRENTSLIDE=0
            CASE CHR$(0) + "O"
                CURRENTSLIDE=SLIDECOUNT-1
            CASE CHR$(0) + "I"
                IF CURRENTSLIDE>0 THEN CURRENTSLIDE=CURRENTSLIDE-1
            CASE CHR$(0) + "Q"
                IF CURRENTSLIDE<SLIDECOUNT-1 THEN CURRENTSLIDE=CURRENTSLIDE+1
            CASE ELSE

        END SELECT
    LOOP
END SUB
